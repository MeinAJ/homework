# 捐款智能合约需求清单

## 一、核心捐款功能

### 1. 接收捐款
- **支持币种**
  - ETH原生代币
  - ERC20代币（需白名单管理）
- **捐款记录**
  - 捐赠者地址
  - 金额（ETH/代币数量）
  - 时间戳（区块时间）
  - 交易哈希（TxHash）
- **高级功能**
  - 最小捐款金额限制
  - 捐款留言/元数据（链下存储方案）
  - 匿名捐赠机制
  - 实名捐赠（需KYC/AML集成）

### 2. 捐款者功能
- **历史查询**
  - 按时间范围/代币类型查询
  - 总捐赠额统计（支持价值换算）
- **隐私管理**
  - 可撤销的隐私保护（可选）
- **捐赠证明**
  - 链上不可篡改证明
  - 链下PDF收据（需系统集成）

## 二、资金管理与分配

### 3. 资金保管
- **安全机制**
  - 合约托管资金
  - M-of-N多重签名提现（如3-of-5）
- **提款管理**
  - 目标地址灵活性（EOA/合约）
  - 单次提款上限
  - 周期提款上限（日/周/月）
  - 提款冷却期（应急响应窗口）
- **资金分配**
  - 指定用途标签（链上记录）
  - 自动分配规则（预设百分比）
  - 阈值触发分配机制

### 4. 资金流向透明
- **提款记录**
  - 时间戳
  - 目标地址
  - 金额
  - 交易哈希
  - 操作者签名
  - 用途标签
- **审计功能**
  - 实时余额查询（ETH/ERC20）
  - 全链路资金追踪

## 三、透明性与报告

### 5. 链上数据可访问
- **关键事件日志**
DonationReceived(address,uint256,address,uint256)
WithdrawalExecuted(address[],address,uint256,address,string,uint256)
- **视图函数**
- 总捐款额统计
- 捐赠者历史查询
- 提款记录分页访问
- 实时合约状态查询

### 6. 链下报告集成
- **价值锚定**
- 预言机集成（Chainlink等）法定货币计价
- **去中心化存储**
- 报告文件存IPFS/Arweave
- 内容哈希链上记录
- **自动触发**
- 定时/里程碑触发报告生成

## 四、治理与权限管理

### 7. 管理员权限
- **角色分离模型**
| 角色 | 权限 |
|------|------|
| DEFAULT_ADMIN_ROLE | 超级权限（多签控制） |
| WITHDRAWAL_ROLE | 提款操作权限 |
| CONFIG_ROLE | 参数配置权限 |
| REPORT_ROLE | 报告提交权限（可选） |
- **多签强制**
- 关键操作必须通过多签钱包执行

### 8. 治理机制（可选）
- **提案类型**
- 管理员变更
- 代币白名单更新
- 合约升级
- 特殊提款批准
- **投票参数**
- 投票延迟/时长
- 法定人数阈值
- 通过率设置

## 五、安全与防护

### 9. 合约安全
- **攻击防护**
- 重入攻击防护（nonReentrant）
- 整数溢出/下溢防护
- **操作防护**
- 严格输入验证
- 权限检查（onlyRole）
- ETH滞留预防
- **紧急措施**
- 全局暂停开关（停止捐款/提款）

### 10. 代币风险管理
- **白名单控制**
- CONFIG_ROLE管理代币列表
- 代币安全性评估机制
- **异常处理**
- 非标准ERC20兼容方案
- 恶意代币拦截

### 11. 私钥管理
- **硬件钱包存储**
- **多签配置安全**
- **零热钱包原则**

## 六、升级与维护

### 12. 可升级性
- **代理模式**
- 透明代理（TransparentUpgradeableProxy）
- UUPS代理
- **升级控制**
- 多签/治理审批流程
- 升级事件记录

### 13. 所有权管理
- 去中心化所有权（DAO/多签金库）

## 七、用户体验与前端集成

### 14. 用户界面(UI)
- **核心功能**
- 多币种捐赠页面
- 实时Gas估算
- 钱包连接（MetaMask等）
- **透明度面板**
- 资金流向可视化
- 链上报告直通车

### 15. 性能优化
- Gas消耗优化
- Layer2解决方案（Polygon/Optimism）

### 16. 国际化
- 多语言界面支持

## 八、合规性考虑

### 17. KYC/AML
- 链下验证+链上白名单
- 大额捐赠合规流程

### 18. 税务合规
- 双轨制捐赠证明（链上+PDF）

### 19. 地域限制
- 前端IP拦截（链下实现）

### 20. 数据隐私
- GDPR/CCPA兼容声明
- 匿名捐赠优先

## 九、测试与部署

### 21. 测试方案
| 测试类型 | 覆盖内容 |
|----------|----------|
| 单元测试 | 核心功能逻辑 |
| 集成测试 | 外部组件交互 |
| 攻击模拟 | 重入/溢出/权限绕过 |
| 主网分叉测试 | 真实环境模拟 |

### 22. 安全审计
- 专业审计机构审查
- 漏洞赏金计划

### 23. 部署策略
1. 测试网验证（Goerli/Sepolia）
2. 主网代理部署
3. 多链部署（主网+L2）

### 24. 生产监控
- 关键事件警报
- 余额异常监控
- 实时通知系统（Telegram/Slack）

## 十、扩展性考虑

### 25. 捐赠模式扩展
- 定期捐赠（Gelato集成）
- 目标导向捐赠（进度条+自动解锁）
- NFT捐赠通道

### 26. 激励体系
- 捐赠积分系统
- NFT荣誉徽章

### 27. 生态集成
- GraphQL数据接口
- 第三方分析工具对接
